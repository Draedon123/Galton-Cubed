(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();class j{samples;maxSamples;constructor(e){this.samples=[],this.maxSamples=e}get average(){return this.samples.reduce((e,t)=>e+t,0)/this.samples.length}addSample(e){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(e)}reset(){this.samples.splice(0,this.samples.length)}}class z{static modifiedDevices=new Set;canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(e,t=()=>{}){if(this.canTimestamp=e.features.has("timestamp-query"),this.onUpdate=t,this.rollingAverage=new j(50),this.canTimestamp&&(this.querySet=e.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=e.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*BigInt64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=e.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),!z.modifiedDevices.has(e)){const s=e.queue.submit.bind(e.queue);e.queue.submit=n=>{s(n),!(!this.canTimestamp||this.resultBuffer.mapState!=="unmapped")&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const o=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(o[1]-o[0])),this.resultBuffer.unmap(),this.onUpdate(this.rollingAverage.average)})},z.modifiedDevices.add(e)}}get time(){return this.rollingAverage.average}beginComputePass(e,t){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},n=e.beginComputePass({...t,...this.canTimestamp?{timestampWrites:s}:void 0}),o=n.end.bind(n);return n.end=()=>{o(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},n}beginRenderPass(e,t){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},n=e.beginRenderPass({...t,...this.canTimestamp?{timestampWrites:s}:void 0}),o=n.end.bind(n);return n.end=()=>{o(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},n}reset(){this.rollingAverage.reset()}}class T{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}static multiplyMatrices(e,t,s=new T){const n=e.components[0],o=e.components[1],i=e.components[2],r=e.components[3],h=e.components[4],l=e.components[5],f=e.components[6],v=e.components[7],u=e.components[8],d=e.components[9],a=e.components[10],p=e.components[11],B=e.components[12],x=e.components[13],M=e.components[14],S=e.components[15];let g=t.components[0],y=t.components[1],w=t.components[2],b=t.components[3];return s.components[0]=g*n+y*h+w*u+b*B,s.components[1]=g*o+y*l+w*d+b*x,s.components[2]=g*i+y*f+w*a+b*M,s.components[3]=g*r+y*v+w*p+b*S,g=t.components[4],y=t.components[5],w=t.components[6],b=t.components[7],s.components[4]=g*n+y*h+w*u+b*B,s.components[5]=g*o+y*l+w*d+b*x,s.components[6]=g*i+y*f+w*a+b*M,s.components[7]=g*r+y*v+w*p+b*S,g=t.components[8],y=t.components[9],w=t.components[10],b=t.components[11],s.components[8]=g*n+y*h+w*u+b*B,s.components[9]=g*o+y*l+w*d+b*x,s.components[10]=g*i+y*f+w*a+b*M,s.components[11]=g*r+y*v+w*p+b*S,g=t.components[12],y=t.components[13],w=t.components[14],b=t.components[15],s.components[12]=g*n+y*h+w*u+b*B,s.components[13]=g*o+y*l+w*d+b*x,s.components[14]=g*i+y*f+w*a+b*M,s.components[15]=g*r+y*v+w*p+b*S,s}static perspective(e,t,s,n){const o=new T,i=1/Math.tan(e/2);if(o.components[0]=i/t,o.components[5]=i,o.components[11]=-1,o.components[15]=0,n!==1/0){const r=1/(s-n);o.components[10]=n*r,o.components[14]=n*s*r}else o.components[10]=-1,o.components[14]=-s;return o}static lookAt(e,t,s){const n=new T,o=1e-6;let i,r,h,l,f,v,u,d,a,p;const B=e.x,x=e.y,M=e.z,S=s.x,g=s.y,y=s.z,w=t.x,b=t.y,C=t.z;return Math.abs(B-w)<o&&Math.abs(x-b)<o&&Math.abs(M-C)<o?(console.warn("Look At too close to Position"),new T):(u=B-w,d=x-b,a=M-C,p=1/Math.sqrt(u*u+d*d+a*a),u*=p,d*=p,a*=p,i=g*a-y*d,r=y*u-S*a,h=S*d-g*u,p=Math.sqrt(i*i+r*r+h*h),p?(p=1/p,i*=p,r*=p,h*=p):(i=0,r=0,h=0),l=d*h-a*r,f=a*i-u*h,v=u*r-d*i,p=Math.sqrt(l*l+f*f+v*v),p?(p=1/p,l*=p,f*=p,v*=p):(l=0,f=0,v=0),n.components[0]=i,n.components[1]=l,n.components[2]=u,n.components[3]=0,n.components[4]=r,n.components[5]=f,n.components[6]=d,n.components[7]=0,n.components[8]=h,n.components[9]=v,n.components[10]=a,n.components[11]=0,n.components[12]=-(i*B+r*x+h*M),n.components[13]=-(l*B+f*x+v*M),n.components[14]=-(u*B+d*x+a*M),n.components[15]=1,n)}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this.components[4]=e.components[4],this.components[5]=e.components[5],this.components[6]=e.components[6],this.components[7]=e.components[7],this.components[8]=e.components[8],this.components[9]=e.components[9],this.components[10]=e.components[10],this.components[11]=e.components[11],this.components[12]=e.components[12],this.components[13]=e.components[13],this.components[14]=e.components[14],this.components[15]=e.components[15],this}invert(){const e=this.components[0],t=this.components[1],s=this.components[2],n=this.components[3],o=this.components[4],i=this.components[5],r=this.components[6],h=this.components[7],l=this.components[8],f=this.components[9],v=this.components[10],u=this.components[11],d=this.components[12],a=this.components[13],p=this.components[14],B=this.components[15],x=e*i-t*o,M=e*r-s*o,S=e*h-n*o,g=t*r-s*i,y=t*h-n*i,w=s*h-n*r,b=l*a-f*d,C=l*p-v*d,G=l*B-u*d,A=f*p-v*a,k=f*B-u*a,F=v*B-u*p,V=x*F-M*k+S*A+g*G-y*C+w*b;if(V<1e-8)return console.warn("Determinant is too close to 0. Matrix not inverted"),this;const P=1/V;return this.components[0]=(i*F-r*k+h*A)*P,this.components[1]=(s*k-t*F-n*A)*P,this.components[2]=(a*w-p*y+B*g)*P,this.components[3]=(v*y-f*w-u*g)*P,this.components[4]=(r*G-o*F-h*C)*P,this.components[5]=(e*F-s*G+n*C)*P,this.components[6]=(p*S-d*w-B*M)*P,this.components[7]=(l*w-v*S+u*M)*P,this.components[8]=(o*k-i*G+h*b)*P,this.components[9]=(t*G-e*k-n*b)*P,this.components[10]=(d*y-a*S+B*x)*P,this.components[11]=(f*S-l*y-u*x)*P,this.components[12]=(i*C-o*A-r*b)*P,this.components[13]=(e*A-t*C+s*b)*P,this.components[14]=(a*M-d*g-p*x)*P,this.components[15]=(l*g-f*M+v*x)*P,this}transpose(){const e=this.components[1],t=this.components[2],s=this.components[3],n=this.components[6],o=this.components[7],i=this.components[11];return this.components[1]=this.components[4],this.components[2]=this.components[8],this.components[3]=this.components[12],this.components[4]=e,this.components[6]=this.components[9],this.components[7]=this.components[13],this.components[8]=t,this.components[9]=n,this.components[11]=this.components[14],this.components[12]=s,this.components[13]=o,this.components[14]=i,this}}class Z extends T{buffer;device;constructor(e,t,s=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){super(),this.device=e,this.buffer=e.createBuffer({label:t,usage:s,size:64}),this.device=e}writeBuffer(){this.device.queue.writeBuffer(this.buffer,0,this.components.buffer)}}function K(m){return`/Galton-Cubed/${m}`}class N{buffer;dataview;littleEndian;offset;constructor(e,t=!0,s=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=s}writeUint8(e){this.dataview.setUint8(this.offset,e),this.offset+=1}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeVec3f(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeMat3x3f(e){for(let t=0;t<9;t++)this.writeFloat32(e.components[t]),t%3===2&&this.pad(4)}writeMat4x4f(e){for(let t=0;t<16;t++)this.writeFloat32(e.components[t])}pad(e){this.offset+=e}}class c{components;constructor(e=0,t=0,s=0){this.components=new Float32Array([e,t,s])}static cross(e,t){const s=e.components[0],n=e.components[1],o=e.components[2],i=t.components[0],r=t.components[1],h=t.components[2];return new c(n*h-o*r,o*i-s*h,s*r-n*i)}static add(e,t){return new c(e.components[0]+t.components[0],e.components[1]+t.components[1],e.components[2]+t.components[2])}add(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}static subtract(e,t){return new c(e.components[0]-t.components[0],e.components[1]-t.components[1],e.components[2]-t.components[2])}subtract(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}static scale(e,t){return new c(e.components[0]*t,e.components[1]*t,e.components[2]*t)}scale(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}normalise(){const e=this.magnitude;if(e<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const t=1/e;return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}}class ${vertexBuffer;indexBuffer;vertices;indices;rawVertices;rawIndices;label;constructor(e,t,s=""){this.rawVertices=e,this.rawIndices=t??null,this.label=s}initialise(e){this.vertices=new Float32Array(this.rawVertices.map(t=>[t.position.x,t.position.y,t.position.z,t.normal.x,t.normal.y,t.normal.z]).flat()),this.rawIndices!==null?(this.indices=new(this.indexFormat==="uint16"?Uint16Array:Uint32Array)(this.rawIndices),this.indexBuffer=e.createBuffer({label:`${this.label} Index Buffer`,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,size:this.indices.byteLength}),e.queue.writeBuffer(this.indexBuffer,0,this.indices.buffer)):(this.indices=null,this.indexBuffer=null),this.vertexBuffer=e.createBuffer({label:`${this.label} Vertex Buffer`,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,size:this.vertices.byteLength}),e.queue.writeBuffer(this.vertexBuffer,0,this.vertices.buffer)}render(e){this.indexBuffer!==null?e.drawIndexed(this.indexCount):e.draw(this.rawVertices.length)}bind(e,t=0){e.setVertexBuffer(t,this.vertexBuffer),this.indexBuffer!==null&&e.setIndexBuffer(this.indexBuffer,this.indexFormat)}get verticeCount(){return this.rawVertices.length}get indexCount(){return this.indices?.length??0}get indexFormat(){return this.vertices.length>65535?"uint32":"uint16"}}class I extends ${constructor(e,t){const s=[],n=[],o=[new c(1,0,0),new c(-1,0,0),new c(0,1,0),new c(0,-1,0),new c(0,0,1),new c(0,0,-1)];for(let i=0;i<o.length;i++){const r=o[i],h=I.createCubeFace(r,i*e*e,e,t);for(const l of h.vertices)s.push(l);for(const l of h.indices)n.push(l)}super(s,n)}static createCubeFace(e,t,s,n){const o=[],i=[],r=new c(e.y,e.z,e.x).scale(2*n),h=c.cross(e,r),l=c.subtract(c.scale(e,.5*n),c.add(r,h).scale(.5)),f=c.scale(r,1/s),v=c.scale(h,1/s);for(let u=0;u<s;u++)for(let d=0;d<s;d++){const a=c.add(l,c.scale(f,u)).add(c.scale(v,d)).normalise();a.x*=Math.sqrt(1-.5*a.y*a.y-.5*a.z*a.z+a.y*a.y*a.z*a.z/3),a.y*=Math.sqrt(1-.5*a.x*a.x-.5*a.z*a.z+a.x*a.x*a.z*a.z/3),a.z*=Math.sqrt(1-.5*a.y*a.y-.5*a.x*a.x+a.y*a.y*a.x*a.x/3),a.normalise();const p=c.scale(a,n);if(o.push({position:p,normal:a}),u!==s-1&&d!==s-1){const B=t+u+d*s;i.push(B,B+1,B+s+1,B,B+s+1,B+s)}}return{vertices:o,indices:i}}}class W{mesh;sceneBuffer;objects;initialised;device;maxObjects;constructor(e){this.initialised=!1,this.maxObjects=e,this.objects=[],this.mesh=new I(30,1)}initialise(e){this.initialised||(this.device=e,this.mesh.initialise(e),this.sceneBuffer=e.createBuffer({label:"Ball Scene Buffer",size:this.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.initialised=!0)}update(){if(!this.initialised)return;const e=new N(this.byteLength);e.writeFloat32(this.objects.length),e.pad(12);for(const t of this.objects){const s=t.calculateModelMatrix();e.writeMat4x4f(s),e.writeVec3f(c.scale(t.colour,1/255)),e.pad(4)}this.device.queue.writeBuffer(this.sceneBuffer,0,e.buffer)}get byteLength(){return 16+this.maxObjects*20*4}}const H=Math.PI/180;function U(m){return m*H}const J=180/Math.PI;function D(m){return m*J}function X(m,e,t){return Math.max(Math.min(m,t),e)}class Q{keybinds;keysDown;constructor(e){this.keysDown=new Set,this.keybinds=new Set(e)}addEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}isKeyDown(e){return this.keysDown.has(e)}onKeyDown(e){const t=e.code;this.keybinds.has(t)&&this.keysDown.add(t)}onKeyUp(e){const t=e.code;this.keysDown.delete(t)}}class _{position;forward;aspectRatio;near;far;movementSpeed;mouseSensitivity;pitch;yaw;fovRadians;keyboardManager;keybinds;constructor(e={}){this.position=e.position??new c,this.forward=new c(0,0,-1),this.aspectRatio=e.aspectRatio??16/9,this.near=e.near??.1,this.far=e.far??1e3,this.fovRadians=U(e.fovDegrees??60),this.movementSpeed=e.movementSpeed??1,this.mouseSensitivity=e.mouseSensitivity??1,this.pitch=0,this.yaw=-90,this.keybinds={forwards:e.keybinds?.forwards??"KeyW",backwards:e.keybinds?.backwards??"KeyS",left:e.keybinds?.left??"KeyA",right:e.keybinds?.right??"KeyD",up:e.keybinds?.up??"Space",down:e.keybinds?.down??"ShiftLeft"},this.keyboardManager=new Q(Object.values(this.keybinds)),this.addEventListeners()}checkKeyboardInputs(e){const t=this.movementSpeed*e;this.keyboardManager.isKeyDown(this.keybinds.forwards)&&this.position.add(c.scale(this.forward,t)),this.keyboardManager.isKeyDown(this.keybinds.backwards)&&this.position.subtract(c.scale(this.forward,t)),this.keyboardManager.isKeyDown(this.keybinds.left)&&this.position.subtract(c.cross(this.forward,new c(0,1,0)).normalise().scale(t)),this.keyboardManager.isKeyDown(this.keybinds.right)&&this.position.add(c.cross(this.forward,new c(0,1,0)).normalise().scale(t)),this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=t),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=t)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",e=>{const t=e.movementX*this.mouseSensitivity,s=-e.movementY*this.mouseSensitivity;this.yaw+=t,this.pitch=X(this.pitch+s,-89.9,89.9),this.updateForwardVector()})}get fovDegrees(){return D(this.fovRadians)}set fovDegrees(e){this.fovRadians=U(e)}getPerspectiveMatrix(){return T.perspective(this.fovRadians,this.aspectRatio,this.near,this.far)}getViewMatrix(){const e=new c(0,1,0);return T.lookAt(this.position,c.add(this.position,this.forward),e)}getPerspectiveViewMatrix(){return T.multiplyMatrices(this.getPerspectiveMatrix(),this.getViewMatrix())}updateForwardVector(){const e=U(this.yaw),t=U(this.pitch),s=Math.cos(e),n=Math.cos(t),o=Math.sin(e),i=Math.sin(t),r=new c(s*n,i,o*n).normalise();this.forward=r}}class R{shader;constructor(e,t,s){this.shader=e.createShaderModule({label:s,code:t})}static async fetch(e,t,s,n=o=>o){const o=await(await fetch(t)).text(),i=await R.preprocess(t,o);return new R(e,n(i),s)}static async preprocess(e,t){return R.resolveImports(e,t)}static async resolveImports(e,t,s=[]){const n=/#!import.*\s/g,o=e.split("/"),i=o.slice(0,o.length-1).join("/")+"/",r=t.match(n)?.map(l=>l.replaceAll(/(#!import)|\s/g,"")).filter(l=>!s.includes(l)).map(l=>i+l+".wgsl")??[];return((await Promise.all(r.map(async l=>{const f=await fetch(l);if(!f.ok)return"";const v=await f.text();return R.resolveImports(l,v,s)}))).join("")+t).replaceAll(n,"")}}class L{canvas;camera;settings;ballScene;device;ctx;canvasFormat;gpuTimer;initialised;renderBindGroup;renderPipeline;depthTexture;perspectiveViewMatrix;constructor(e,t,s){const n=e.getContext("webgpu");if(n===null)throw new Error("Could not create WebGPU Canvas Context");this.settings={timing:t.timing},this.canvas=e,this.device=s,this.ctx=n,this.canvasFormat="rgba8unorm",this.camera=new _(t.cameraOptions),this.ballScene=t.scene??new W(100),this.perspectiveViewMatrix=new Z(s,"Perspective View Matrix"),this.gpuTimer=new z(this.device,o=>{const i=o/1e3,r=o/1e6,h=o/1e9,l=r>1,f=(l?r:i).toFixed(2),v=l?"ms":"μs";if(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent=f+v),this.settings.timing?.fpsElement!==void 0){const u=1/h;this.settings.timing.fpsElement.textContent=u.toFixed(2)}}),this.gpuTimer.canTimestamp||(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent="[Not supported by browser]"),this.settings.timing?.fpsElement!==void 0&&(this.settings.timing.fpsElement.textContent="[Not supported by browser]")),this.initialised=!1}async initialise(){this.initialised||(this.ballScene.initialise(this.device),this.ballScene.update(),await this.initialiseRendering(),new ResizeObserver(e=>{const t=e[0],s=t.devicePixelContentBoxSize[0].inlineSize,n=t.devicePixelContentBoxSize[0].blockSize;this.canvas.width=s,this.canvas.height=n,this.camera.aspectRatio=s/n,this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture(),this.gpuTimer.reset(),this.render()}).observe(this.canvas),this.initialised=!0)}createDepthTexture(){return this.device.createTexture({label:"Renderer Depth Texture",size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const e=await R.fetch(this.device,K("shaders/render.wgsl"));this.depthTexture=this.createDepthTexture();const t=this.device.createBindGroupLayout({label:"Cube Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bing Group",layout:t,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrix.buffer}},{binding:1,resource:{buffer:this.ballScene.sceneBuffer}}]});const s=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[t]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:s,vertex:{module:e.shader,buffers:[{arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}]},fragment:{module:e.shader,targets:[{format:this.canvasFormat}]},primitive:{cullMode:"front"},depthStencil:{format:"depth24plus",depthCompare:"less",depthWriteEnabled:!0}})}render(){this.perspectiveViewMatrix.copyFrom(this.camera.getPerspectiveViewMatrix()),this.perspectiveViewMatrix.writeBuffer(),this.renderToCanvas()}renderToCanvas(){const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginRenderPass(e,{colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});this.ballScene.mesh.bind(t),t.setBindGroup(0,this.renderBindGroup),t.setPipeline(this.renderPipeline),t.drawIndexed(this.ballScene.mesh.indexCount,this.ballScene.objects.length),t.end(),this.device.queue.submit([e.finish()])}static async create(e,t={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const s=await navigator.gpu.requestAdapter();if(s===null)throw new Error("Could not find suitable GPU Adapter. Maybe your browser doesn't support WebGPU?");const n=await s.requestDevice({requiredFeatures:L.requestFeatures(s,"timestamp-query")});if(n===null)throw new Error("Could not find suitable GPU Device. Maybe your browser doesn't support WebGPU?");return new L(e,t,n)}static requestFeatures(e,...t){return t.filter(s=>{const n=e.features.has(s);return n||console.warn(`GPU Feature ${s} not supported`),n})}}class ee{settings;callbacks=[];frameID;lastFrameTime;totalTime;constructor(e={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.callbacks=[],this.settings={wormholeThreshold:e.wormholeThreshold??500}}start(){this.running||(this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.lastFrameTime<0&&(this.lastFrameTime=e);const t=e-this.lastFrameTime,s=this.totalTime+t;if(t<this.settings.wormholeThreshold){const n={deltaTime:t,totalTime:s};for(const o of this.callbacks)o(n);this.totalTime=s}this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function te(m){se()}function se(){const m=document.getElementById("chevron"),e=document.getElementById("content");if(m===null)throw new Error("Could not find chevron element");if(e===null)throw new Error("Could not find info panel");m.addEventListener("click",()=>{m.classList.toggle("collapsed"),e.classList.toggle("collapsed")})}class O{device;board;gpuTimer;bindGroup;computePipeline;settingsBuffer;ballStatesBuffer;_executionTimeMs;constructor(e,t,s){this.device=t,this.board=s,this.gpuTimer=new z(t,h=>{this._executionTimeMs=h/1e3}),this._executionTimeMs=0;const n=16;this.settingsBuffer=t.createBuffer({label:"Ball Physics Shader Settings Buffer",size:n,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const o=new N(n);o.writeFloat32(0),o.writeUint32(s.pegCount),o.writeFloat32(s.pegRadius),o.writeFloat32(s.ballRadius),t.queue.writeBuffer(this.settingsBuffer,0,o.buffer),this.ballStatesBuffer=t.createBuffer({label:"Ball Physics Shader Ball States Buffer",size:s.ballCount*8*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const i=t.createBindGroupLayout({label:"Ball Physics Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=t.createBindGroup({label:"Ball Physics Shader Bind Group",layout:i,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:s.scene.sceneBuffer}},{binding:2,resource:{buffer:this.ballStatesBuffer}}]});const r=t.createPipelineLayout({label:"Ball Physics Shader Compute Pipeline Layout",bindGroupLayouts:[i]});this.computePipeline=t.createComputePipeline({label:"Ball Physics Shader Compute Pipeline",layout:r,compute:{module:e.shader}})}get executionTimeMs(){return this._executionTimeMs}run(e){this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([e]),0,1);const t=this.device.createCommandEncoder(),s=this.gpuTimer.beginComputePass(t,{label:"Ball Physics Shader Compute Pass"});s.setBindGroup(0,this.bindGroup),s.setPipeline(this.computePipeline),s.dispatchWorkgroups(Math.ceil(this.board.ballCount/8),Math.ceil(this.board.ballCount/8),1),s.end(),this.device.queue.submit([t.finish()])}static async create(e,t){const s=await R.fetch(e,K("shaders/ballPhysics.wgsl"));return new O(s,e,t)}}class q{components;constructor(){this.components=new Float32Array(9),this.components[0]=1,this.components[4]=1,this.components[8]=1}static fromMatrix4(e){const t=new q;return t.components[0]=e.components[0],t.components[1]=e.components[1],t.components[2]=e.components[2],t.components[3]=e.components[4],t.components[4]=e.components[5],t.components[5]=e.components[6],t.components[6]=e.components[8],t.components[7]=e.components[9],t.components[8]=e.components[10],t}transpose(){const e=this.components[1],t=this.components[2],s=this.components[5];return this.components[1]=this.components[3],this.components[2]=this.components[6],this.components[3]=e,this.components[5]=this.components[7],this.components[6]=t,this.components[7]=s,this}}class E{components;constructor(e=0,t=0,s=0,n=1){this.components=new Float32Array([e,t,s,n])}getEulerAngles(){this.normalise();const e=this.toRotationMatrix();let t,s;const n=Math.asin(-X(e.components[2],-1,1));return Math.abs(e.components[2])<.9999999?(t=Math.atan2(e.components[6],e.components[10]),s=Math.atan2(e.components[1],e.components[0])):(t=0,s=Math.atan2(-e.components[4],e.components[5])),[D(t),D(n),D(s)]}get eulerX(){return this.getEulerAngles()[0]}get eulerY(){return this.getEulerAngles()[1]}get eulerZ(){return this.getEulerAngles()[2]}set eulerX(e){const t=this.getEulerAngles();this.multiply(E.fromEulerAngles(e,t[1],t[2]))}set eulerY(e){const t=this.getEulerAngles();this.copyFrom(E.fromEulerAngles(t[0],e,t[2]))}set eulerZ(e){const t=this.getEulerAngles();this.copyFrom(E.fromEulerAngles(t[0],t[1],e))}rotateX(e){this.multiply(E.fromEulerAngles(e,0,0))}rotateY(e){this.multiply(E.fromEulerAngles(0,e,0))}rotateZ(e){this.multiply(E.fromEulerAngles(0,0,e))}multiply(e){const t=this.x,s=this.y,n=this.z,o=this.w,i=e.x,r=e.y,h=e.z,l=e.w;return this.x=o*i+t*l+s*h-n*r,this.y=o*r-t*h+s*l+n*i,this.z=o*h+t*r-s*i+n*l,this.w=o*l-t*i-s*r-n*h,this}toRotationMatrix(){const e=this.x,t=this.y,s=this.z,n=this.w,o=new T;return o.components[0]=1-2*(t*t+s*s),o.components[1]=2*(e*t+s*n),o.components[2]=2*(e*s-t*n),o.components[4]=2*(e*t-s*n),o.components[5]=1-2*(e*e+s*s),o.components[6]=2*(n*e+t*s),o.components[8]=2*(t*n+e*s),o.components[9]=2*(t*s-e*n),o.components[10]=1-2*(e*e+t*t),o}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this}static fromEulerAngles(e,t,s){e=U(e),t=U(t),s=U(s);const n=Math.sin(e/2),o=Math.cos(e/2),i=Math.sin(t/2),r=Math.cos(t/2),h=Math.sin(s/2),l=Math.cos(s/2);return new E(n*r*l-o*i*h,o*i*l+n*r*h,o*r*h-n*i*l,o*r*l+n*i*h)}normalise(){const e=this.magnitude;if(e<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const t=1/e;return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this.components[3]*=t,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2],this.components[3])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}get w(){return this.components[3]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}set w(e){this.components[3]=e}}class Y{position;rotation;scale;colour;constructor(e={}){this.position=e.position??new c,this.rotation=e.rotation??new E,this.scale=e.scale??new c(1,1,1),this.colour=e.colour??new c(255,255,255)}calculateModelMatrix(){const e=this.rotation.toRotationMatrix();return e.components[0]*=this.scale.x,e.components[1]*=this.scale.x,e.components[2]*=this.scale.x,e.components[4]*=this.scale.y,e.components[5]*=this.scale.y,e.components[6]*=this.scale.y,e.components[8]*=this.scale.z,e.components[9]*=this.scale.z,e.components[10]*=this.scale.z,e.components[12]=this.position.x,e.components[13]=this.position.y,e.components[14]=this.position.z,e}calculateNormalMatrix(e){return q.fromMatrix4(new T().copyFrom(e).invert()).transpose()}}function ne(m,e,t){const s=255*e*t,n=m/60,o=s*(1-Math.abs(n%2-1));return n<1?new c(s,o,0):n<2?new c(o,s,0):n<3?new c(0,s,o):n<4?new c(0,o,s):n<5?new c(o,0,s):new c(s,0,o)}class oe{scene;ballCount;pegCount;ballRadius;pegRadius;initialised;ballPhysicsShader;constructor(e={}){this.initialised=!1,this.ballCount=e.ballCount??100,this.pegRadius=e.pegRadius??4,this.ballRadius=e.ballRadius??1;const t=e.start??new c(0,0,0),s=this.createPegs(e.layers??5,e.height??50,e.sideLength??100,t),n=this.createBalls(this.ballCount,c.add(t,new c(0,10,0)));this.pegCount=s.length,this.scene=new W(this.pegCount+this.ballCount);for(const o of s)this.scene.objects.push(o);for(const o of n)this.scene.objects.push(o)}createPegs(e,t,s,n){const o=[],i=e===1?t:t/(e-1),r=s/e;for(let h=0;h<e;h++){const l=n.y-h*i,f=(e-h)/2,v=c.add(n,new c(-s/2,l,-s/2)).add(new c(f*r,0,f*r)),u=ne(360*(h/e),1,1);for(let d=0;d<h+1;d++){const a=d*r;for(let p=0;p<h+1;p++){const B=p*r,x=c.add(v,new c(a,0,B));o.push(new Y({position:x,scale:new c(this.pegRadius,this.pegRadius,this.pegRadius),colour:u}))}}}return o}createBalls(e,t){const s=this.ballRadius*4,n=[];for(let o=1;o<=e;o++){const i=.2*this.ballRadius*(Math.random()-.5),r=.2*this.ballRadius*(Math.random()-.5);n.push(new Y({position:c.add(t,new c(i,s*o,r)),scale:new c(this.ballRadius,this.ballRadius,this.ballRadius)}))}return n}tick(e){this.initialised&&this.ballPhysicsShader.run(e)}async initialise(e){this.initialised||(this.ballPhysicsShader=await O.create(e,this),this.initialised=!0)}}async function ie(){const m=document.getElementById("main"),e=document.getElementById("frameTime"),t=document.getElementById("fps"),s=new oe({ballCount:100}),n=await L.create(m,{scene:s.scene,cameraOptions:{mouseSensitivity:.1,movementSpeed:.1},timing:{frameTimeElement:e,fpsElement:t}});await n.initialise(),await s.initialise(n.device),n.camera.position=new c(0,10,20),n.camera.fovDegrees=60,te();const o=new ee;o.addCallback(i=>{n.camera.checkKeyboardInputs(i.deltaTime),s.tick(i.deltaTime),n.render()}),o.start(),m.addEventListener("click",()=>{m.requestPointerLock()})}ie().catch(m=>{const e=m instanceof Error?m.message:JSON.stringify(m),t=document.getElementById("message");t.classList.add("error"),t.textContent=e;const s=document.getElementById("chevron"),n=document.getElementById("content");s?.classList.add("collapsed"),n?.classList.add("collapsed"),console.trace(),console.error(e)});
