(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();class K{samples;maxSamples;constructor(t){this.samples=[],this.maxSamples=t}get average(){return this.samples.reduce((t,e)=>t+e,0)/this.samples.length}addSample(t){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(t)}reset(){this.samples.splice(0,this.samples.length)}}class I{static modifiedDevices=new Set;canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(t,e=()=>{}){if(this.canTimestamp=t.features.has("timestamp-query"),this.onUpdate=e,this.rollingAverage=new K(50),this.canTimestamp&&(this.querySet=t.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=t.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*BigInt64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=t.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),!I.modifiedDevices.has(t)){const s=t.queue.submit.bind(t.queue);t.queue.submit=n=>{s(n),!(!this.canTimestamp||this.resultBuffer.mapState!=="unmapped")&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const o=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(o[1]-o[0])),this.resultBuffer.unmap(),this.onUpdate(this.rollingAverage.average)})},I.modifiedDevices.add(t)}}get time(){return this.rollingAverage.average}beginComputePass(t,e){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},n=t.beginComputePass({...e,...this.canTimestamp?{timestampWrites:s}:void 0}),o=n.end.bind(n);return n.end=()=>{o(),this.canTimestamp&&(t.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&t.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},n}beginRenderPass(t,e){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},n=t.beginRenderPass({...e,...this.canTimestamp?{timestampWrites:s}:void 0}),o=n.end.bind(n);return n.end=()=>{o(),this.canTimestamp&&(t.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&t.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},n}reset(){this.rollingAverage.reset()}}class T{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}static multiplyMatrices(t,e,s=new T){const n=t.components[0],o=t.components[1],i=t.components[2],c=t.components[3],m=t.components[4],a=t.components[5],f=t.components[6],g=t.components[7],u=t.components[8],d=t.components[9],r=t.components[10],p=t.components[11],w=t.components[12],B=t.components[13],M=t.components[14],S=t.components[15];let y=e.components[0],b=e.components[1],v=e.components[2],x=e.components[3];return s.components[0]=y*n+b*m+v*u+x*w,s.components[1]=y*o+b*a+v*d+x*B,s.components[2]=y*i+b*f+v*r+x*M,s.components[3]=y*c+b*g+v*p+x*S,y=e.components[4],b=e.components[5],v=e.components[6],x=e.components[7],s.components[4]=y*n+b*m+v*u+x*w,s.components[5]=y*o+b*a+v*d+x*B,s.components[6]=y*i+b*f+v*r+x*M,s.components[7]=y*c+b*g+v*p+x*S,y=e.components[8],b=e.components[9],v=e.components[10],x=e.components[11],s.components[8]=y*n+b*m+v*u+x*w,s.components[9]=y*o+b*a+v*d+x*B,s.components[10]=y*i+b*f+v*r+x*M,s.components[11]=y*c+b*g+v*p+x*S,y=e.components[12],b=e.components[13],v=e.components[14],x=e.components[15],s.components[12]=y*n+b*m+v*u+x*w,s.components[13]=y*o+b*a+v*d+x*B,s.components[14]=y*i+b*f+v*r+x*M,s.components[15]=y*c+b*g+v*p+x*S,s}static perspective(t,e,s,n){const o=new T,i=1/Math.tan(t/2);if(o.components[0]=i/e,o.components[5]=i,o.components[11]=-1,o.components[15]=0,n!==1/0){const c=1/(s-n);o.components[10]=n*c,o.components[14]=n*s*c}else o.components[10]=-1,o.components[14]=-s;return o}static lookAt(t,e,s){const n=new T,o=1e-6;let i,c,m,a,f,g,u,d,r,p;const w=t.x,B=t.y,M=t.z,S=s.x,y=s.y,b=s.z,v=e.x,x=e.y,A=e.z;return Math.abs(w-v)<o&&Math.abs(B-x)<o&&Math.abs(M-A)<o?(console.warn("Look At too close to Position"),new T):(u=w-v,d=B-x,r=M-A,p=1/Math.sqrt(u*u+d*d+r*r),u*=p,d*=p,r*=p,i=y*r-b*d,c=b*u-S*r,m=S*d-y*u,p=Math.sqrt(i*i+c*c+m*m),p?(p=1/p,i*=p,c*=p,m*=p):(i=0,c=0,m=0),a=d*m-r*c,f=r*i-u*m,g=u*c-d*i,p=Math.sqrt(a*a+f*f+g*g),p?(p=1/p,a*=p,f*=p,g*=p):(a=0,f=0,g=0),n.components[0]=i,n.components[1]=a,n.components[2]=u,n.components[3]=0,n.components[4]=c,n.components[5]=f,n.components[6]=d,n.components[7]=0,n.components[8]=m,n.components[9]=g,n.components[10]=r,n.components[11]=0,n.components[12]=-(i*w+c*B+m*M),n.components[13]=-(a*w+f*B+g*M),n.components[14]=-(u*w+d*B+r*M),n.components[15]=1,n)}copyFrom(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this.components[3]=t.components[3],this.components[4]=t.components[4],this.components[5]=t.components[5],this.components[6]=t.components[6],this.components[7]=t.components[7],this.components[8]=t.components[8],this.components[9]=t.components[9],this.components[10]=t.components[10],this.components[11]=t.components[11],this.components[12]=t.components[12],this.components[13]=t.components[13],this.components[14]=t.components[14],this.components[15]=t.components[15],this}invert(){const t=this.components[0],e=this.components[1],s=this.components[2],n=this.components[3],o=this.components[4],i=this.components[5],c=this.components[6],m=this.components[7],a=this.components[8],f=this.components[9],g=this.components[10],u=this.components[11],d=this.components[12],r=this.components[13],p=this.components[14],w=this.components[15],B=t*i-e*o,M=t*c-s*o,S=t*m-n*o,y=e*c-s*i,b=e*m-n*i,v=s*m-n*c,x=a*r-f*d,A=a*p-g*d,U=a*w-u*d,D=f*p-g*r,z=f*w-u*r,F=g*w-u*p,q=B*F-M*z+S*D+y*U-b*A+v*x;if(q<1e-8)return console.warn("Determinant is too close to 0. Matrix not inverted"),this;const E=1/q;return this.components[0]=(i*F-c*z+m*D)*E,this.components[1]=(s*z-e*F-n*D)*E,this.components[2]=(r*v-p*b+w*y)*E,this.components[3]=(g*b-f*v-u*y)*E,this.components[4]=(c*U-o*F-m*A)*E,this.components[5]=(t*F-s*U+n*A)*E,this.components[6]=(p*S-d*v-w*M)*E,this.components[7]=(a*v-g*S+u*M)*E,this.components[8]=(o*z-i*U+m*x)*E,this.components[9]=(e*U-t*z-n*x)*E,this.components[10]=(d*b-r*S+w*B)*E,this.components[11]=(f*S-a*b-u*B)*E,this.components[12]=(i*A-o*D-c*x)*E,this.components[13]=(t*D-e*A+s*x)*E,this.components[14]=(r*M-d*y-p*B)*E,this.components[15]=(a*y-f*M+g*B)*E,this}transpose(){const t=this.components[1],e=this.components[2],s=this.components[3],n=this.components[6],o=this.components[7],i=this.components[11];return this.components[1]=this.components[4],this.components[2]=this.components[8],this.components[3]=this.components[12],this.components[4]=t,this.components[6]=this.components[9],this.components[7]=this.components[13],this.components[8]=e,this.components[9]=n,this.components[11]=this.components[14],this.components[12]=s,this.components[13]=o,this.components[14]=i,this}}class N extends T{buffer;device;constructor(t,e,s=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){super(),this.device=t,this.buffer=t.createBuffer({label:e,usage:s,size:64}),this.device=t}writeBuffer(){this.device.queue.writeBuffer(this.buffer,0,this.components.buffer)}}function X(l){return`/Galton-Cubed/${l}`}class W{buffer;dataview;littleEndian;offset;constructor(t,e=!0,s=0){this.buffer=new ArrayBuffer(t),this.dataview=new DataView(this.buffer),this.littleEndian=e,this.offset=s}writeUint8(t){this.dataview.setUint8(this.offset,t),this.offset+=1}writeUint32(t){this.dataview.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat32(t){this.dataview.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeVec3f(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}writeMat3x3f(t){for(let e=0;e<9;e++)this.writeFloat32(t.components[e]),e%3===2&&this.pad(4)}writeMat4x4f(t){for(let e=0;e<16;e++)this.writeFloat32(t.components[e])}pad(t){this.offset+=t}}class h{components;constructor(t=0,e=0,s=0){this.components=new Float32Array([t,e,s])}static cross(t,e){const s=t.components[0],n=t.components[1],o=t.components[2],i=e.components[0],c=e.components[1],m=e.components[2];return new h(n*m-o*c,o*i-s*m,s*c-n*i)}static add(t,e){return new h(t.components[0]+e.components[0],t.components[1]+e.components[1],t.components[2]+e.components[2])}add(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this}static subtract(t,e){return new h(t.components[0]-e.components[0],t.components[1]-e.components[1],t.components[2]-e.components[2])}subtract(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this.components[2]-=t.components[2],this}static scale(t,e){return new h(t.components[0]*e,t.components[1]*e,t.components[2]*e)}scale(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}normalise(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const e=1/t;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}}class j{vertexBuffer;indexBuffer;vertices;indices;rawVertices;rawIndices;label;constructor(t,e,s=""){this.rawVertices=t,this.rawIndices=e??null,this.label=s}initialise(t){this.vertices=new Float32Array(this.rawVertices.map(e=>[e.position.x,e.position.y,e.position.z,e.normal.x,e.normal.y,e.normal.z]).flat()),this.rawIndices!==null?(this.indices=new(this.indexFormat==="uint16"?Uint16Array:Uint32Array)(this.rawIndices),this.indexBuffer=t.createBuffer({label:`${this.label} Index Buffer`,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,size:this.indices.byteLength}),t.queue.writeBuffer(this.indexBuffer,0,this.indices.buffer)):(this.indices=null,this.indexBuffer=null),this.vertexBuffer=t.createBuffer({label:`${this.label} Vertex Buffer`,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,size:this.vertices.byteLength}),t.queue.writeBuffer(this.vertexBuffer,0,this.vertices.buffer)}render(t){this.indexBuffer!==null?t.drawIndexed(this.indexCount):t.draw(this.rawVertices.length)}bind(t,e=0){t.setVertexBuffer(e,this.vertexBuffer),this.indexBuffer!==null&&t.setIndexBuffer(this.indexBuffer,this.indexFormat)}get verticeCount(){return this.rawVertices.length}get indexCount(){return this.indices?.length??0}get indexFormat(){return this.vertices.length>65535?"uint32":"uint16"}}class G extends j{constructor(t,e){const s=[],n=[],o=[new h(1,0,0),new h(-1,0,0),new h(0,1,0),new h(0,-1,0),new h(0,0,1),new h(0,0,-1)];for(let i=0;i<o.length;i++){const c=o[i],m=G.createCubeFace(c,i*t*t,t,e);s.push(...m.vertices),n.push(...m.indices)}super(s,n)}static createCubeFace(t,e,s,n){const o=[],i=[],c=new h(t.y,t.z,t.x).scale(2*n),m=h.cross(t,c),a=h.subtract(h.scale(t,.5*n),h.add(c,m).scale(.5)),f=h.scale(c,1/s),g=h.scale(m,1/s);for(let u=0;u<s;u++)for(let d=0;d<s;d++){const r=h.add(a,h.scale(f,u)).add(h.scale(g,d)).normalise();r.x*=Math.sqrt(1-.5*r.y*r.y-.5*r.z*r.z+r.y*r.y*r.z*r.z/3),r.y*=Math.sqrt(1-.5*r.x*r.x-.5*r.z*r.z+r.x*r.x*r.z*r.z/3),r.z*=Math.sqrt(1-.5*r.y*r.y-.5*r.x*r.x+r.y*r.y*r.x*r.x/3),r.normalise();const p=h.scale(r,n);if(o.push({position:p,normal:r}),u!==s-1&&d!==s-1){const w=e+u+d*s;i.push(w,w+1,w+s+1,w,w+s+1,w+s)}}return{vertices:o,indices:i}}}class V{sceneBuffer;mesh;objects;initialised;device;maxObjects;constructor(t){this.initialised=!1,this.maxObjects=t,this.objects=[],this.mesh=new G(30,1)}initialise(t){this.initialised||(this.device=t,this.mesh.initialise(t),this.sceneBuffer=t.createBuffer({label:"Ball Scene Buffer",size:this.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.initialised=!0)}update(){if(!this.initialised)return;const t=new W(this.byteLength);t.writeFloat32(this.objects.length),t.pad(12);for(const e of this.objects){const s=e.calculateModelMatrix();t.writeMat4x4f(s),t.writeVec3f(h.scale(e.colour,1/255)),t.pad(4)}this.device.queue.writeBuffer(this.sceneBuffer,0,t.buffer)}get byteLength(){return 16+this.maxObjects*20*4}}const Z=Math.PI/180;function C(l){return l*Z}const $=180/Math.PI;function R(l){return l*$}function Y(l,t,e){return Math.max(Math.min(l,e),t)}class H{keybinds;keysDown;constructor(t){this.keysDown=new Set,this.keybinds=new Set(t)}addEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}isKeyDown(t){return this.keysDown.has(t)}onKeyDown(t){const e=t.code;this.keybinds.has(e)&&this.keysDown.add(e)}onKeyUp(t){const e=t.code;this.keysDown.delete(e)}}class J{position;forward;aspectRatio;near;far;movementSpeed;mouseSensitivity;pitch;yaw;fovRadians;keyboardManager;keybinds;constructor(t={}){this.position=t.position??new h,this.forward=new h(0,0,-1),this.aspectRatio=t.aspectRatio??16/9,this.near=t.near??.1,this.far=t.far??1e3,this.fovRadians=C(t.fovDegrees??60),this.movementSpeed=t.movementSpeed??1,this.mouseSensitivity=t.mouseSensitivity??1,this.pitch=0,this.yaw=-90,this.keybinds={forwards:t.keybinds?.forwards??"KeyW",backwards:t.keybinds?.backwards??"KeyS",left:t.keybinds?.left??"KeyA",right:t.keybinds?.right??"KeyD",up:t.keybinds?.up??"Space",down:t.keybinds?.down??"ShiftLeft"},this.keyboardManager=new H(Object.values(this.keybinds)),this.addEventListeners()}checkKeyboardInputs(t){const e=this.movementSpeed*t;this.keyboardManager.isKeyDown(this.keybinds.forwards)&&this.position.add(h.scale(this.forward,e)),this.keyboardManager.isKeyDown(this.keybinds.backwards)&&this.position.subtract(h.scale(this.forward,e)),this.keyboardManager.isKeyDown(this.keybinds.left)&&this.position.subtract(h.cross(this.forward,new h(0,1,0)).normalise().scale(e)),this.keyboardManager.isKeyDown(this.keybinds.right)&&this.position.add(h.cross(this.forward,new h(0,1,0)).normalise().scale(e)),this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=e),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=e)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",t=>{const e=t.movementX*this.mouseSensitivity,s=-t.movementY*this.mouseSensitivity;this.yaw+=e,this.pitch=Y(this.pitch+s,-89.9,89.9),this.updateForwardVector()})}get fovDegrees(){return R(this.fovRadians)}set fovDegrees(t){this.fovRadians=C(t)}getPerspectiveMatrix(){return T.perspective(this.fovRadians,this.aspectRatio,this.near,this.far)}getViewMatrix(){const t=new h(0,1,0);return T.lookAt(this.position,h.add(this.position,this.forward),t)}getPerspectiveViewMatrix(){return T.multiplyMatrices(this.getPerspectiveMatrix(),this.getViewMatrix())}updateForwardVector(){const t=C(this.yaw),e=C(this.pitch),s=Math.cos(t),n=Math.cos(e),o=Math.sin(t),i=Math.sin(e),c=new h(s*n,i,o*n).normalise();this.forward=c}}class k{shader;constructor(t,e,s){this.shader=t.createShaderModule({label:s,code:e})}static async fetch(t,e,s,n=o=>o){const o=await(await fetch(e)).text(),i=await k.preprocess(e,o);return new k(t,n(i),s)}static async preprocess(t,e){return k.resolveImports(t,e)}static async resolveImports(t,e,s=[]){const n=/#!import.*\s/g,o=t.split("/"),i=o.slice(0,o.length-1).join("/")+"/",c=e.match(n)?.map(a=>a.replaceAll(/(#!import)|\s/g,"")).filter(a=>!s.includes(a)).map(a=>i+a+".wgsl")??[];return((await Promise.all(c.map(async a=>{const f=await fetch(a);if(!f.ok)return"";const g=await f.text();return k.resolveImports(a,g,s)}))).join("")+e).replaceAll(n,"")}}class L{canvas;camera;settings;ballScene;device;ctx;canvasFormat;gpuTimer;initialised;renderBindGroup;renderPipeline;depthTexture;perspectiveViewMatrix;constructor(t,e,s){const n=t.getContext("webgpu");if(n===null)throw new Error("Could not create WebGPU Canvas Context");this.settings={timing:e.timing},this.canvas=t,this.device=s,this.ctx=n,this.canvasFormat="rgba8unorm",this.camera=new J(e.cameraOptions),this.ballScene=e.scene??new V(100),this.perspectiveViewMatrix=new N(s,"Perspective View Matrix"),this.gpuTimer=new I(this.device,o=>{const i=o/1e3,c=o/1e6,m=o/1e9,a=c>1,f=(a?c:i).toFixed(2),g=a?"ms":"μs";if(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent=f+g),this.settings.timing?.fpsElement!==void 0){const u=1/m;this.settings.timing.fpsElement.textContent=u.toFixed(2)}}),this.gpuTimer.canTimestamp||(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent="[Not supported by browser]"),this.settings.timing?.fpsElement!==void 0&&(this.settings.timing.fpsElement.textContent="[Not supported by browser]")),this.initialised=!1}async initialise(){this.initialised||(this.ballScene.initialise(this.device),this.ballScene.update(),await this.initialiseRendering(),new ResizeObserver(t=>{const e=t[0],s=e.devicePixelContentBoxSize[0].inlineSize,n=e.devicePixelContentBoxSize[0].blockSize;this.canvas.width=s,this.canvas.height=n,this.camera.aspectRatio=s/n,this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture(),this.gpuTimer.reset(),this.render()}).observe(this.canvas),this.initialised=!0)}createDepthTexture(){return this.device.createTexture({label:"Renderer Depth Texture",size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const t=await k.fetch(this.device,X("shaders/render.wgsl"));this.depthTexture=this.createDepthTexture();const e=this.device.createBindGroupLayout({label:"Cube Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bing Group",layout:e,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrix.buffer}},{binding:1,resource:{buffer:this.ballScene.sceneBuffer}}]});const s=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[e]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:s,vertex:{module:t.shader,buffers:[{arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}]},fragment:{module:t.shader,targets:[{format:this.canvasFormat}]},primitive:{},depthStencil:{format:"depth24plus",depthCompare:"less",depthWriteEnabled:!0}})}render(){this.perspectiveViewMatrix.copyFrom(this.camera.getPerspectiveViewMatrix()),this.perspectiveViewMatrix.writeBuffer(),this.renderToCanvas()}renderToCanvas(){const t=this.device.createCommandEncoder(),e=this.gpuTimer.beginRenderPass(t,{colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});this.ballScene.mesh.bind(e),e.setBindGroup(0,this.renderBindGroup),e.setPipeline(this.renderPipeline),e.drawIndexed(this.ballScene.mesh.indexCount,this.ballScene.objects.length),e.end(),this.device.queue.submit([t.finish()])}static async create(t,e={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const s=await navigator.gpu.requestAdapter();if(s===null)throw new Error("Could not find suitable GPU Adapter. Maybe your browser doesn't support WebGPU?");const n=await s.requestDevice({requiredFeatures:L.requestFeatures(s,"timestamp-query")});if(n===null)throw new Error("Could not find suitable GPU Device. Maybe your browser doesn't support WebGPU?");return new L(t,e,n)}static requestFeatures(t,...e){return e.filter(s=>{const n=t.features.has(s);return n||console.warn(`GPU Feature ${s} not supported`),n})}}class Q{settings;callbacks=[];frameID;lastFrameTime;totalTime;constructor(t={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const e=t-this.lastFrameTime,s=this.totalTime+e;if(e<this.settings.wormholeThreshold){const n={deltaTime:e,totalTime:s};for(const o of this.callbacks)o(n);this.totalTime=s}this.lastFrameTime=t,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function _(l){tt()}function tt(){const l=document.getElementById("chevron"),t=document.getElementById("content");if(l===null)throw new Error("Could not find chevron element");if(t===null)throw new Error("Could not find info panel");l.addEventListener("click",()=>{l.classList.toggle("collapsed"),t.classList.toggle("collapsed")})}class O{components;constructor(){this.components=new Float32Array(9),this.components[0]=1,this.components[4]=1,this.components[8]=1}static fromMatrix4(t){const e=new O;return e.components[0]=t.components[0],e.components[1]=t.components[1],e.components[2]=t.components[2],e.components[3]=t.components[4],e.components[4]=t.components[5],e.components[5]=t.components[6],e.components[6]=t.components[8],e.components[7]=t.components[9],e.components[8]=t.components[10],e}transpose(){const t=this.components[1],e=this.components[2],s=this.components[5];return this.components[1]=this.components[3],this.components[2]=this.components[6],this.components[3]=t,this.components[5]=this.components[7],this.components[6]=e,this.components[7]=s,this}}class P{components;constructor(t=0,e=0,s=0,n=1){this.components=new Float32Array([t,e,s,n])}getEulerAngles(){this.normalise();const t=this.toRotationMatrix();let e,s;const n=Math.asin(-Y(t.components[2],-1,1));return Math.abs(t.components[2])<.9999999?(e=Math.atan2(t.components[6],t.components[10]),s=Math.atan2(t.components[1],t.components[0])):(e=0,s=Math.atan2(-t.components[4],t.components[5])),[R(e),R(n),R(s)]}get eulerX(){return this.getEulerAngles()[0]}get eulerY(){return this.getEulerAngles()[1]}get eulerZ(){return this.getEulerAngles()[2]}set eulerX(t){const e=this.getEulerAngles();this.multiply(P.fromEulerAngles(t,e[1],e[2]))}set eulerY(t){const e=this.getEulerAngles();this.copyFrom(P.fromEulerAngles(e[0],t,e[2]))}set eulerZ(t){const e=this.getEulerAngles();this.copyFrom(P.fromEulerAngles(e[0],e[1],t))}rotateX(t){this.multiply(P.fromEulerAngles(t,0,0))}rotateY(t){this.multiply(P.fromEulerAngles(0,t,0))}rotateZ(t){this.multiply(P.fromEulerAngles(0,0,t))}multiply(t){const e=this.x,s=this.y,n=this.z,o=this.w,i=t.x,c=t.y,m=t.z,a=t.w;return this.x=o*i+e*a+s*m-n*c,this.y=o*c-e*m+s*a+n*i,this.z=o*m+e*c-s*i+n*a,this.w=o*a-e*i-s*c-n*m,this}toRotationMatrix(){const t=this.x,e=this.y,s=this.z,n=this.w,o=new T;return o.components[0]=1-2*(e*e+s*s),o.components[1]=2*(t*e+s*n),o.components[2]=2*(t*s-e*n),o.components[4]=2*(t*e-s*n),o.components[5]=1-2*(t*t+s*s),o.components[6]=2*(n*t+e*s),o.components[8]=2*(e*n+t*s),o.components[9]=2*(e*s-t*n),o.components[10]=1-2*(t*t+e*e),o}copyFrom(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this.components[3]=t.components[3],this}static fromEulerAngles(t,e,s){t=C(t),e=C(e),s=C(s);const n=Math.sin(t/2),o=Math.cos(t/2),i=Math.sin(e/2),c=Math.cos(e/2),m=Math.sin(s/2),a=Math.cos(s/2);return new P(n*c*a-o*i*m,o*i*a+n*c*m,o*c*m-n*i*a,o*c*a+n*i*m)}normalise(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const e=1/t;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2],this.components[3])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}get w(){return this.components[3]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}set w(t){this.components[3]=t}}class et{position;rotation;scale;colour;constructor(t={}){this.position=t.position??new h,this.rotation=t.rotation??new P,this.scale=t.scale??new h(1,1,1),this.colour=t.colour??new h(255,255,255)}calculateModelMatrix(){const t=this.rotation.toRotationMatrix();return t.components[0]*=this.scale.x,t.components[1]*=this.scale.x,t.components[2]*=this.scale.x,t.components[4]*=this.scale.y,t.components[5]*=this.scale.y,t.components[6]*=this.scale.y,t.components[8]*=this.scale.z,t.components[9]*=this.scale.z,t.components[10]*=this.scale.z,t.components[12]=this.position.x,t.components[13]=this.position.y,t.components[14]=this.position.z,t}calculateNormalMatrix(t){return O.fromMatrix4(new T().copyFrom(t).invert()).transpose()}}function st(l,t,e){const s=255*t*e,n=l/60,o=s*(1-Math.abs(n%2-1));return n<1?new h(s,o,0):n<2?new h(o,s,0):n<3?new h(0,s,o):n<4?new h(0,o,s):n<5?new h(o,0,s):new h(s,0,o)}class nt{scene;ballCount;pegCount;constructor(t={}){const e=this.createPegs(t.layers??5,t.height??50,t.sideLength??100,t.pegRadius??4);this.ballCount=t.ballCount??100,this.pegCount=e.length,this.scene=new V(this.pegCount+this.ballCount),this.scene.objects.push(...e)}createPegs(t,e,s,n){const o=[],i=new h(0,0,0),c=t===1?e:e/(t-1),m=s/t;for(let a=0;a<t;a++){const f=i.y-a*c,g=(t-a)/2,u=h.add(i,new h(-s/2,f,-s/2)).add(new h(g*m,0,g*m)),d=st(360*(a/t),1,1);for(let r=0;r<a+1;r++){const p=r*m;for(let w=0;w<a+1;w++){const B=w*m,M=h.add(u,new h(p,0,B));o.push(new et({position:M,scale:new h(n,n,n),colour:d}))}}}return o}}async function ot(){const l=document.getElementById("main"),t=document.getElementById("frameTime"),e=document.getElementById("fps"),s=new nt,n=await L.create(l,{scene:s.scene,cameraOptions:{mouseSensitivity:.1,movementSpeed:.1},timing:{frameTimeElement:t,fpsElement:e}});await n.initialise(),n.camera.position=new h(0,-25,100),n.camera.fovDegrees=60,_();const o=new Q;o.addCallback(i=>{n.camera.checkKeyboardInputs(i.deltaTime),n.render()}),o.start(),l.addEventListener("click",()=>{l.requestPointerLock()})}ot().catch(l=>{const t=l instanceof Error?l.message:JSON.stringify(l),e=document.getElementById("message");e.classList.add("error"),e.textContent=t;const s=document.getElementById("chevron"),n=document.getElementById("content");s?.classList.add("collapsed"),n?.classList.add("collapsed"),console.trace(),console.error(t)});
