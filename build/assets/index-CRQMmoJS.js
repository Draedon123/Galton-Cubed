(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class W{samples;maxSamples;constructor(e){this.samples=[],this.maxSamples=e}get average(){return this.samples.reduce((e,t)=>e+t,0)/this.samples.length}addSample(e){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(e)}reset(){this.samples.splice(0,this.samples.length)}}class N{canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(e,t=()=>{}){this.canTimestamp=e.features.has("timestamp-query"),this.onUpdate=t,this.rollingAverage=new W(50),this.canTimestamp&&(this.querySet=e.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=e.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*8,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=e.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}));const n=e.queue.submit.bind(e.queue);e.queue.submit=s=>{n(s),this.canTimestamp&&e.queue.onSubmittedWorkDone().then(()=>{this.resultBuffer.mapState==="unmapped"&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const o=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(o[1]-o[0])),this.resultBuffer.unmap(),this.onUpdate(this.rollingAverage.average)})})}}get time(){return this.rollingAverage.average}beginPass(e,t,n){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},o=e[t==="render"?"beginRenderPass":"beginComputePass"]({...n,...this.canTimestamp?{timestampWrites:s}:void 0}),i=o.end.bind(o);return o.end=()=>{i(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},o}beginComputePass(e,t){return this.beginPass(e,"compute",t)}beginRenderPass(e,t){return this.beginPass(e,"render",t)}reset(){this.rollingAverage.reset()}}class S{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}static multiplyMatrices(e,t,n=new S){const s=e.components[0],o=e.components[1],i=e.components[2],r=e.components[3],h=e.components[4],a=e.components[5],u=e.components[6],f=e.components[7],p=e.components[8],m=e.components[9],g=e.components[10],d=e.components[11],x=e.components[12],v=e.components[13],P=e.components[14],T=e.components[15];let b=t.components[0],w=t.components[1],y=t.components[2],B=t.components[3];return n.components[0]=b*s+w*h+y*p+B*x,n.components[1]=b*o+w*a+y*m+B*v,n.components[2]=b*i+w*u+y*g+B*P,n.components[3]=b*r+w*f+y*d+B*T,b=t.components[4],w=t.components[5],y=t.components[6],B=t.components[7],n.components[4]=b*s+w*h+y*p+B*x,n.components[5]=b*o+w*a+y*m+B*v,n.components[6]=b*i+w*u+y*g+B*P,n.components[7]=b*r+w*f+y*d+B*T,b=t.components[8],w=t.components[9],y=t.components[10],B=t.components[11],n.components[8]=b*s+w*h+y*p+B*x,n.components[9]=b*o+w*a+y*m+B*v,n.components[10]=b*i+w*u+y*g+B*P,n.components[11]=b*r+w*f+y*d+B*T,b=t.components[12],w=t.components[13],y=t.components[14],B=t.components[15],n.components[12]=b*s+w*h+y*p+B*x,n.components[13]=b*o+w*a+y*m+B*v,n.components[14]=b*i+w*u+y*g+B*P,n.components[15]=b*r+w*f+y*d+B*T,n}static perspective(e,t,n,s){const o=new S,i=1/Math.tan(e/2);if(o.components[0]=i/t,o.components[5]=i,o.components[11]=-1,o.components[15]=0,s!==1/0){const r=1/(n-s);o.components[10]=s*r,o.components[14]=s*n*r}else o.components[10]=-1,o.components[14]=-n;return o}static lookAt(e,t,n){const s=new S,o=1e-6;let i,r,h,a,u,f,p,m,g,d;const x=e.x,v=e.y,P=e.z,T=n.x,b=n.y,w=n.z,y=t.x,B=t.y,R=t.z;return Math.abs(x-y)<o&&Math.abs(v-B)<o&&Math.abs(P-R)<o?(console.warn("Look At too close to Position"),new S):(p=x-y,m=v-B,g=P-R,d=1/Math.sqrt(p*p+m*m+g*g),p*=d,m*=d,g*=d,i=b*g-w*m,r=w*p-T*g,h=T*m-b*p,d=Math.sqrt(i*i+r*r+h*h),d?(d=1/d,i*=d,r*=d,h*=d):(i=0,r=0,h=0),a=m*h-g*r,u=g*i-p*h,f=p*r-m*i,d=Math.sqrt(a*a+u*u+f*f),d?(d=1/d,a*=d,u*=d,f*=d):(a=0,u=0,f=0),s.components[0]=i,s.components[1]=a,s.components[2]=p,s.components[3]=0,s.components[4]=r,s.components[5]=u,s.components[6]=m,s.components[7]=0,s.components[8]=h,s.components[9]=f,s.components[10]=g,s.components[11]=0,s.components[12]=-(i*x+r*v+h*P),s.components[13]=-(a*x+u*v+f*P),s.components[14]=-(p*x+m*v+g*P),s.components[15]=1,s)}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this.components[4]=e.components[4],this.components[5]=e.components[5],this.components[6]=e.components[6],this.components[7]=e.components[7],this.components[8]=e.components[8],this.components[9]=e.components[9],this.components[10]=e.components[10],this.components[11]=e.components[11],this.components[12]=e.components[12],this.components[13]=e.components[13],this.components[14]=e.components[14],this.components[15]=e.components[15],this}invert(){const e=this.components[0],t=this.components[1],n=this.components[2],s=this.components[3],o=this.components[4],i=this.components[5],r=this.components[6],h=this.components[7],a=this.components[8],u=this.components[9],f=this.components[10],p=this.components[11],m=this.components[12],g=this.components[13],d=this.components[14],x=this.components[15],v=e*i-t*o,P=e*r-n*o,T=e*h-s*o,b=t*r-n*i,w=t*h-s*i,y=n*h-s*r,B=a*g-u*m,R=a*d-f*m,k=a*x-p*m,L=u*d-f*g,O=u*x-p*g,A=f*x-p*d,Y=v*A-P*O+T*L+b*k-w*R+y*B;if(Y<1e-8)return console.warn("Determinant is too close to 0. Matrix not inverted"),this;const M=1/Y;return this.components[0]=(i*A-r*O+h*L)*M,this.components[1]=(n*O-t*A-s*L)*M,this.components[2]=(g*y-d*w+x*b)*M,this.components[3]=(f*w-u*y-p*b)*M,this.components[4]=(r*k-o*A-h*R)*M,this.components[5]=(e*A-n*k+s*R)*M,this.components[6]=(d*T-m*y-x*P)*M,this.components[7]=(a*y-f*T+p*P)*M,this.components[8]=(o*O-i*k+h*B)*M,this.components[9]=(t*k-e*O-s*B)*M,this.components[10]=(m*w-g*T+x*v)*M,this.components[11]=(u*T-a*w-p*v)*M,this.components[12]=(i*R-o*L-r*B)*M,this.components[13]=(e*L-t*R+n*B)*M,this.components[14]=(g*P-m*b-d*v)*M,this.components[15]=(a*b-u*P+f*v)*M,this}transpose(){const e=this.components[1],t=this.components[2],n=this.components[3],s=this.components[6],o=this.components[7],i=this.components[11];return this.components[1]=this.components[4],this.components[2]=this.components[8],this.components[3]=this.components[12],this.components[4]=e,this.components[6]=this.components[9],this.components[7]=this.components[13],this.components[8]=t,this.components[9]=s,this.components[11]=this.components[14],this.components[12]=n,this.components[13]=o,this.components[14]=i,this}}class Z extends S{buffer;device;constructor(e,t,n=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){super(),this.device=e,this.buffer=e.createBuffer({label:t,usage:n,size:64}),this.device=e}writeBuffer(){this.device.queue.writeBuffer(this.buffer,0,this.components.buffer)}}function K(l){return`/Galton-Cubed/${l}`}const $=Math.PI/180;function U(l){return l*$}const H=180/Math.PI;function z(l){return l*H}function X(l,e,t){return Math.max(Math.min(l,t),e)}class J{keybinds;keysDown;constructor(e){this.keysDown=new Set,this.keybinds=new Set(e)}addEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}isKeyDown(e){return this.keysDown.has(e)}onKeyDown(e){const t=e.code;this.keybinds.has(t)&&this.keysDown.add(t)}onKeyUp(e){const t=e.code;this.keysDown.delete(t)}}class c{components;constructor(e=0,t=0,n=0){this.components=new Float32Array([e,t,n])}static cross(e,t){const n=e.components[0],s=e.components[1],o=e.components[2],i=t.components[0],r=t.components[1],h=t.components[2];return new c(s*h-o*r,o*i-n*h,n*r-s*i)}static add(e,t){return new c(e.components[0]+t.components[0],e.components[1]+t.components[1],e.components[2]+t.components[2])}add(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}static subtract(e,t){return new c(e.components[0]-t.components[0],e.components[1]-t.components[1],e.components[2]-t.components[2])}subtract(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}static scale(e,t){return new c(e.components[0]*t,e.components[1]*t,e.components[2]*t)}scale(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}static normalise(e){return c.clone(e).normalise()}normalise(){const e=this.magnitude;if(e<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const t=1/e;return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}static clone(e){return new c(e.components[0],e.components[1],e.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}}class Q{position;forward;aspectRatio;near;far;movementSpeed;mouseSensitivity;pitch;yaw;fovRadians;keyboardManager;keybinds;constructor(e={}){this.position=e.position??new c,this.forward=new c(0,0,-1),this.aspectRatio=e.aspectRatio??16/9,this.near=e.near??.1,this.far=e.far??1e3,this.fovRadians=U(e.fovDegrees??60),this.movementSpeed=e.movementSpeed??1,this.mouseSensitivity=e.mouseSensitivity??1,this.pitch=0,this.yaw=-90,this.keybinds={forwards:e.keybinds?.forwards??"KeyW",backwards:e.keybinds?.backwards??"KeyS",left:e.keybinds?.left??"KeyA",right:e.keybinds?.right??"KeyD",up:e.keybinds?.up??"Space",down:e.keybinds?.down??"ShiftLeft"},this.keyboardManager=new J(Object.values(this.keybinds)),this.addEventListeners()}checkKeyboardInputs(e){const t=this.movementSpeed*e;this.keyboardManager.isKeyDown(this.keybinds.forwards)&&this.position.add(c.scale(this.forward,t)),this.keyboardManager.isKeyDown(this.keybinds.backwards)&&this.position.subtract(c.scale(this.forward,t)),this.keyboardManager.isKeyDown(this.keybinds.left)&&this.position.subtract(c.cross(this.forward,new c(0,1,0)).normalise().scale(t)),this.keyboardManager.isKeyDown(this.keybinds.right)&&this.position.add(c.cross(this.forward,new c(0,1,0)).normalise().scale(t)),this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=t),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=t)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",e=>{const t=e.movementX*this.mouseSensitivity,n=-e.movementY*this.mouseSensitivity;this.yaw+=t,this.pitch=X(this.pitch+n,-89.9,89.9),this.updateForwardVector()})}get fovDegrees(){return z(this.fovRadians)}set fovDegrees(e){this.fovRadians=U(e)}getPerspectiveMatrix(){return S.perspective(this.fovRadians,this.aspectRatio,this.near,this.far)}getViewMatrix(){const e=new c(0,1,0);return S.lookAt(this.position,c.add(this.position,this.forward),e)}getPerspectiveViewMatrix(){return S.multiplyMatrices(this.getPerspectiveMatrix(),this.getViewMatrix())}updateForwardVector(){const e=U(this.yaw),t=U(this.pitch),n=Math.cos(e),s=Math.cos(t),o=Math.sin(e),i=Math.sin(t),r=new c(n*s,i,o*s).normalise();this.forward=r}}class C{shader;constructor(e,t,n){this.shader=e.createShaderModule({label:n,code:t})}static async fetch(e,t,n,s=o=>o){const o=await(await fetch(t)).text(),i=await C.preprocess(t,o);return new C(e,s(i),n)}static async preprocess(e,t){return C.resolveImports(e,t)}static async resolveImports(e,t,n=[]){const s=/#!import.*\s/g,o=e.split("/"),i=o.slice(0,o.length-1).join("/")+"/",r=t.match(s)?.map(a=>a.replaceAll(/(#!import)|\s/g,"")).filter(a=>!n.includes(a)).map(a=>i+a+".wgsl")??[];return((await Promise.all(r.map(async a=>{const u=await fetch(a);if(!u.ok)return"";const f=await u.text();return C.resolveImports(a,f,n)}))).join("")+t).replaceAll(s,"")}}class q{buffer;dataview;littleEndian;offset;constructor(e,t=!0,n=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=n}writeUint8(e){this.dataview.setUint8(this.offset,e),this.offset+=1}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeVec3f(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeMat3x3f(e){for(let t=0;t<9;t++)this.writeFloat32(e.components[t]),t%3===2&&this.pad(4)}writeMat4x4f(e){for(let t=0;t<16;t++)this.writeFloat32(e.components[t])}pad(e){this.offset+=e}}class G{mesh;scene;objects;initialised;device;constructor(e){this.initialised=!1,this.objects=[],this.mesh=e}initialise(e,t){this.initialised||(e.scenes.push(this),this.device=t,this.scene=e,this.mesh.initialise(t),this.initialised=!0,this.update())}update(e=this.objects.length){if(!this.initialised)return;const t=new q(e*G.objectByteLength);for(let n=this.objects.length-e;n<this.objects.length;n++){const s=this.objects[n],o=s.calculateModelMatrix();t.writeMat4x4f(o),t.writeVec3f(c.scale(s.colour,1/255)),t.pad(4)}this.device.queue.writeBuffer(this.scene.sceneBuffer,this.sceneByteOffset+(this.objects.length-e)*G.objectByteLength,t.buffer)}addObject(e){const t=this.scene?.scenes.indexOf(this),n=this.scene?.maxObjectsPerScene[t];if(this.objects.length>=n){console.warn(`Maximum number of objects reached (${n}). New objects not added`);return}this.objects.push(e)}get objectCount(){return this.objects.length}get sceneByteOffset(){const e=this.scene.scenes.indexOf(this);return this.scene.scenes.reduce((t,n,s)=>s>=e?t:t+n.byteLength,0)}get maxObjects(){return this.scene.maxObjectsPerScene[this.scene.scenes.indexOf(this)]}get byteLength(){return this.maxObjects*G.objectByteLength}static get objectByteLength(){return 80}}class _{maxObjectsPerScene;maxScenes;scenes;sceneBuffer;initialised;constructor(e,t=128){this.maxObjectsPerScene=typeof t=="number"?new Array(e).fill(0).map(()=>t):Array.from({length:e},(s,o)=>t[o]??128),this.maxScenes=e,this.scenes=[];const n=this.scenes.push.bind(this.scenes);this.scenes.push=(...s)=>{for(const o of s){if(this.scenes.length>=this.maxScenes){console.warn("Maximum number of scenes reached. New scenes not added");break}n(o)}return this.scenes.length},this.initialised=!1}initialise(e){if(!this.initialised){this.sceneBuffer=e.createBuffer({label:"Scene Buffer",size:this.maxScenes*this.maxObjectsPerScene.reduce((t,n)=>t+n,0)*G.objectByteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});for(const t of this.scenes)t.initialise(this,e),t.update();this.initialised=!0}}}class D{canvas;camera;scenes;device;ctx;canvasFormat;gpuTimer;initialised;renderBindGroup;renderPipeline;depthTexture;parametersBuffer;perspectiveViewMatrix;constructor(e,t,n){const s=e.getContext("webgpu");if(s===null)throw new Error("Could not create WebGPU Canvas Context");this.canvas=e,this.device=n,this.ctx=s,this.canvasFormat="rgba8unorm",this.camera=new Q(t.cameraOptions),this.scenes=t.scene;const o=document.getElementById("renderFrameTime"),i=document.getElementById("fps");this.gpuTimer=new N(this.device,r=>{const h=r/1e3,a=r/1e6,u=r/1e9,f=a>1,p=(f?a:h).toFixed(2),m=f?"ms":"μs",g=1/u;o.textContent=p+m,i.textContent=g.toFixed(2)}),this.gpuTimer.canTimestamp||(o.textContent="[Not supported by browser]",i.textContent="[Not supported by browser]"),this.parametersBuffer=n.createBuffer({label:"Parameters Buffer",size:this.scenes.maxScenes*256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.perspectiveViewMatrix=new Z(n,"Perspective View Matrix"),this.initialised=!1}async initialise(){if(this.initialised)return;this.scenes.initialise(this.device),await this.initialiseRendering();const e=new q(this.scenes.maxScenes*256);for(let t=0;t<this.scenes.maxObjectsPerScene.length;t++){const n=this.scenes.maxObjectsPerScene[t-1]??0;e.writeUint32(n),e.pad(252)}this.device.queue.writeBuffer(this.parametersBuffer,0,e.buffer),new ResizeObserver(t=>{const n=t[0],s=n.devicePixelContentBoxSize[0].inlineSize,o=n.devicePixelContentBoxSize[0].blockSize;this.canvas.width=s,this.canvas.height=o,this.camera.aspectRatio=s/o,this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture(),this.render()}).observe(this.canvas),this.initialised=!0}createDepthTexture(){return this.device.createTexture({label:"Renderer Depth Texture",size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const e=await C.fetch(this.device,K("shaders/render.wgsl"));this.depthTexture=this.createDepthTexture();const t=this.device.createBindGroupLayout({label:"Render Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX},{binding:2,buffer:{type:"uniform",hasDynamicOffset:!0},visibility:GPUShaderStage.VERTEX}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrix.buffer}},{binding:1,resource:{buffer:this.scenes.sceneBuffer}},{binding:2,resource:{buffer:this.parametersBuffer,size:256}}]});const n=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[t]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:n,vertex:{module:e.shader,buffers:[{arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}]},fragment:{module:e.shader,targets:[{format:this.canvasFormat}]},primitive:{cullMode:"front"},depthStencil:{format:"depth24plus",depthCompare:"less",depthWriteEnabled:!0}})}render(){this.perspectiveViewMatrix.copyFrom(this.camera.getPerspectiveViewMatrix()),this.perspectiveViewMatrix.writeBuffer(),this.renderToCanvas()}renderToCanvas(){const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginRenderPass(e,{colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});t.setPipeline(this.renderPipeline);for(let n=0;n<this.scenes.scenes.length;n++){const s=this.scenes.scenes[n];s.objectCount!==0&&(t.setBindGroup(0,this.renderBindGroup,[n*256]),s.mesh.bind(t),t.drawIndexed(s.mesh.indexCount,s.objectCount))}t.end(),this.device.queue.submit([e.finish()])}static async create(e,t){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const n=await navigator.gpu.requestAdapter();if(n===null)throw new Error("Could not find suitable GPU Adapter. Maybe your browser doesn't support WebGPU?");const s=await n.requestDevice({requiredFeatures:D.requestFeatures(n,"timestamp-query")});if(s===null)throw new Error("Could not find suitable GPU Device. Maybe your browser doesn't support WebGPU?");return new D(e,t,s)}static requestFeatures(e,...t){return t.filter(n=>{const s=e.features.has(n);return s||console.warn(`GPU Feature ${n} not supported`),s})}}class ee{settings;callbacks=[];frameID;lastFrameTime;totalTime;frame;constructor(e={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:e.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.lastFrameTime<0&&(this.lastFrameTime=e);const t=e-this.lastFrameTime,n=this.totalTime+t;if(t<this.settings.wormholeThreshold){const s={deltaTime:t,totalTime:n,frame:this.frame++};for(const o of this.callbacks)o(s);this.totalTime=n}this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function te(l){se()}function se(){const l=document.getElementById("chevron"),e=document.getElementById("content");if(l===null)throw new Error("Could not find chevron element");if(e===null)throw new Error("Could not find info panel");l.addEventListener("click",()=>{l.classList.toggle("collapsed"),e.classList.toggle("collapsed")})}function ne(l,e){return l+e-l%e}class F{static SETTINGS_BYTE_LENGTH=ne(24,16);device;board;gpuTimer;bindGroup;computePipeline;settingsBuffer;ballVelocitiesBuffer;constructor(e,t,n){this.device=t,this.board=n;const s=document.getElementById("computeFrameTime");this.gpuTimer=new N(t,r=>{const h=r/1e3,a=r/1e6,u=a>1,m=(u?a:h).toFixed(2)+(u?"ms":"μs");s.textContent=m}),this.settingsBuffer=t.createBuffer({label:"Ball Physics Shader Settings Buffer",size:F.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.ballVelocitiesBuffer=t.createBuffer({label:"Ball Physics Shader Ball States Buffer",size:n.maxBallCount*4*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const o=t.createBindGroupLayout({label:"Ball Physics Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=t.createBindGroup({label:"Ball Physics Shader Bind Group",layout:o,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:n.spheres.scene.sceneBuffer}},{binding:2,resource:{buffer:this.ballVelocitiesBuffer}}]});const i=t.createPipelineLayout({label:"Ball Physics Shader Compute Pipeline Layout",bindGroupLayouts:[o]});this.computePipeline=t.createComputePipeline({label:"Ball Physics Shader Compute Pipeline",layout:i,compute:{module:e.shader}})}updateSettings(e){const t=new q(F.SETTINGS_BYTE_LENGTH);t.writeFloat32(e),t.writeUint32(this.board.pegCount),t.writeFloat32(this.board.pegRadius),t.writeFloat32(this.board.ballRadius),t.writeUint32(this.board.ballCount),t.writeFloat32(this.board.start.y-this.board.height-this.board.floorOffset+this.board.ballRadius+this.board.floorThickness),this.device.queue.writeBuffer(this.settingsBuffer,0,t.buffer)}run(e){this.updateSettings(e);const t=this.device.createCommandEncoder(),n=this.gpuTimer.beginComputePass(t,{label:"Ball Physics Shader Compute Pass"});n.setBindGroup(0,this.bindGroup),n.setPipeline(this.computePipeline),n.dispatchWorkgroups(Math.ceil(this.board.ballCount/64),1,1),n.end(),this.device.queue.submit([t.finish()])}static async create(e,t){const n=await C.fetch(e,K("shaders/ballPhysics.wgsl"));return new F(n,e,t)}}class V{components;constructor(){this.components=new Float32Array(9),this.components[0]=1,this.components[4]=1,this.components[8]=1}static fromMatrix4(e){const t=new V;return t.components[0]=e.components[0],t.components[1]=e.components[1],t.components[2]=e.components[2],t.components[3]=e.components[4],t.components[4]=e.components[5],t.components[5]=e.components[6],t.components[6]=e.components[8],t.components[7]=e.components[9],t.components[8]=e.components[10],t}transpose(){const e=this.components[1],t=this.components[2],n=this.components[5];return this.components[1]=this.components[3],this.components[2]=this.components[6],this.components[3]=e,this.components[5]=this.components[7],this.components[6]=t,this.components[7]=n,this}}class E{components;constructor(e=0,t=0,n=0,s=1){this.components=new Float32Array([e,t,n,s])}getEulerAngles(){this.normalise();const e=this.toRotationMatrix();let t,n;const s=Math.asin(-X(e.components[2],-1,1));return Math.abs(e.components[2])<.9999999?(t=Math.atan2(e.components[6],e.components[10]),n=Math.atan2(e.components[1],e.components[0])):(t=0,n=Math.atan2(-e.components[4],e.components[5])),[z(t),z(s),z(n)]}get eulerX(){return this.getEulerAngles()[0]}get eulerY(){return this.getEulerAngles()[1]}get eulerZ(){return this.getEulerAngles()[2]}set eulerX(e){const t=this.getEulerAngles();this.multiply(E.fromEulerAngles(e,t[1],t[2]))}set eulerY(e){const t=this.getEulerAngles();this.copyFrom(E.fromEulerAngles(t[0],e,t[2]))}set eulerZ(e){const t=this.getEulerAngles();this.copyFrom(E.fromEulerAngles(t[0],t[1],e))}rotateX(e){this.multiply(E.fromEulerAngles(e,0,0))}rotateY(e){this.multiply(E.fromEulerAngles(0,e,0))}rotateZ(e){this.multiply(E.fromEulerAngles(0,0,e))}multiply(e){const t=this.x,n=this.y,s=this.z,o=this.w,i=e.x,r=e.y,h=e.z,a=e.w;return this.x=o*i+t*a+n*h-s*r,this.y=o*r-t*h+n*a+s*i,this.z=o*h+t*r-n*i+s*a,this.w=o*a-t*i-n*r-s*h,this}toRotationMatrix(){const e=this.x,t=this.y,n=this.z,s=this.w,o=new S;return o.components[0]=1-2*(t*t+n*n),o.components[1]=2*(e*t+n*s),o.components[2]=2*(e*n-t*s),o.components[4]=2*(e*t-n*s),o.components[5]=1-2*(e*e+n*n),o.components[6]=2*(s*e+t*n),o.components[8]=2*(t*s+e*n),o.components[9]=2*(t*n-e*s),o.components[10]=1-2*(e*e+t*t),o}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this}static fromEulerAngles(e,t,n){e=U(e),t=U(t),n=U(n);const s=Math.sin(e/2),o=Math.cos(e/2),i=Math.sin(t/2),r=Math.cos(t/2),h=Math.sin(n/2),a=Math.cos(n/2);return new E(s*r*a-o*i*h,o*i*a+s*r*h,o*r*h-s*i*a,o*r*a+s*i*h)}normalise(){const e=this.magnitude;if(e<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const t=1/e;return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this.components[3]*=t,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2],this.components[3])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}get w(){return this.components[3]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}set w(e){this.components[3]=e}}class j{position;scale;colour;constructor(e={}){this.position=e.position??new c,this.scale=e.scale??new c(1,1,1),this.colour=e.colour??new c(255,255,255)}calculateModelMatrix(){const e=E.fromEulerAngles(0,0,0).toRotationMatrix();return e.components[0]*=this.scale.x,e.components[1]*=this.scale.x,e.components[2]*=this.scale.x,e.components[4]*=this.scale.y,e.components[5]*=this.scale.y,e.components[6]*=this.scale.y,e.components[8]*=this.scale.z,e.components[9]*=this.scale.z,e.components[10]*=this.scale.z,e.components[12]=this.position.x,e.components[13]=this.position.y,e.components[14]=this.position.z,e}calculateNormalMatrix(e){return V.fromMatrix4(new S().copyFrom(e).invert()).transpose()}}function oe(l,e,t){const n=255*e*t,s=l/60,o=n*(1-Math.abs(s%2-1));return s<1?new c(n,o,0):s<2?new c(o,n,0):s<3?new c(0,n,o):s<4?new c(0,o,n):s<5?new c(o,0,n):new c(n,0,o)}class ie{vertexBuffer;indexBuffer;device;vertices;indices;rawVertices;rawIndices;label;constructor(e,t,n=""){this.rawVertices=e,this.rawIndices=t??null,this.label=n}initialise(e){this.device=e,this.update(this.rawVertices,this.rawIndices??void 0,!0)}update(e,t,n=!1){if(this.device)if(this.vertices=new Float32Array(e.map(s=>[s.position.x,s.position.y,s.position.z,s.normal.x,s.normal.y,s.normal.z]).flat()),(e.length!==this.rawVertices.length||n)&&(this.vertexBuffer?.destroy(),this.vertexBuffer=this.device.createBuffer({label:`${this.label} Vertex Buffer`,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,size:this.vertices.byteLength})),this.device.queue.writeBuffer(this.vertexBuffer,0,this.vertices.buffer),t!==void 0){const s=this.indexFormat==="uint16"?Uint16Array:Uint32Array;this.indices=new s(t),(this.rawIndices?.length!==t.length||n)&&(this.indexBuffer?.destroy(),this.indexBuffer=this.device.createBuffer({label:`${this.label} Index Buffer`,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,size:this.indices.byteLength})),this.device.queue.writeBuffer(this.indexBuffer,0,this.indices.buffer)}else this.indices=null,this.indexBuffer=null}render(e){this.indexBuffer!==null?e.drawIndexed(this.indexCount):e.draw(this.rawVertices.length)}bind(e,t=0){e.setVertexBuffer(t,this.vertexBuffer),this.indexBuffer!==null&&e.setIndexBuffer(this.indexBuffer,this.indexFormat)}get verticeCount(){return this.rawVertices.length}get indexCount(){return this.indices?.length??0}get indexFormat(){return this.vertices.length>65535?"uint32":"uint16"}}class I extends ie{constructor(e,t){const n=[],s=[],o=[new c(1,0,0),new c(-1,0,0),new c(0,1,0),new c(0,-1,0),new c(0,0,1),new c(0,0,-1)];for(let i=0;i<o.length;i++){const r=o[i],h=I.createCubeFace(r,i*(e+1)*(e+1),e,t);for(const a of h.vertices)n.push(a);for(const a of h.indices)s.push(a)}super(n,s)}static createCubeFace(e,t,n,s){const o=[],i=[],r=new c(e.y,e.z,e.x).scale(s),h=c.cross(e,r).normalise().scale(s),a=c.subtract(c.scale(e,.5*s),c.add(r,h).scale(.5)),u=c.scale(r,1/n),f=c.scale(h,1/n);for(let p=0;p<=n;p++)for(let m=0;m<=n;m++){const g=c.scale(u,p).add(c.scale(f,m)),d=c.add(a,g);if(o.push({position:d,normal:e}),p<n&&m<n){const x=t+p+m*(n+1);i.push(x,x+1,x+n+2,x,x+n+2,x+n+1)}}return{vertices:o,indices:i}}}class re extends I{constructor(e,t){super(e,t*2),this.rawVertices.forEach(n=>{n.position.normalise().scale(.5*t*2);const s=c.normalise(n.position);s.x*=Math.sqrt(1-.5*s.y*s.y-.5*s.z*s.z+s.y*s.y*s.z*s.z/3),s.y*=Math.sqrt(1-.5*s.x*s.x-.5*s.z*s.z+s.x*s.x*s.z*s.z/3),s.z*=Math.sqrt(1-.5*s.y*s.y-.5*s.x*s.x+s.y*s.y*s.x*s.x/3),n.normal=s.normalise()})}}class ce{scene;spheres;floor;maxBallCount;pegCount;ballRadius;pegRadius;floorResolution;floorOffset;floorThickness;height;start;sideLength;initialised;ballPhysicsShader;constructor(e={}){this.initialised=!1,this.maxBallCount=e.ballCount??100,this.pegRadius=e.pegRadius??4,this.ballRadius=e.ballRadius??1,this.floorResolution=e.floorResolution??256,this.floorOffset=e.floorOffset??this.pegRadius*5,this.floorThickness=e.floorThickness??1,this.sideLength=e.sideLength??100,this.height=e.height??50,this.start=e.start??new c(0,0,0);const t=this.createPegs(e.layers??5);this.pegCount=t.length,this.spheres=new G(new re(10,1)),this.floor=new G(new I(1,1));for(const s of t)this.spheres.addObject(s);const n=this.createFloor();for(const s of n)this.floor.addObject(s);this.scene=new _(2,[this.pegCount+this.maxBallCount,this.floorResolution*this.floorResolution])}get ballCount(){return this.spheres.objectCount-this.pegCount}createPegs(e){const t=[],n=e===1?this.height:this.height/(e-1),s=this.sideLength/e;for(let o=0;o<e;o++){const i=this.start.y-o*n,r=(e-o)/2,h=c.add(this.start,new c(-this.sideLength/2,i,-this.sideLength/2)).add(new c(r*s,0,r*s)),a=oe(360*(o/e),1,1);for(let u=0;u<o+1;u++){const f=u*s;for(let p=0;p<o+1;p++){const m=p*s,g=c.add(h,new c(f,0,m));t.push(new j({position:g,scale:new c(this.pegRadius,this.pegRadius,this.pegRadius),colour:a}))}}}return t}createFloor(){const e=[],t=this.sideLength*2,n=c.subtract(this.start,new c(t*.5,this.floorOffset+this.height,t*.5)),s=t/this.floorResolution,o=new c(255,255,255),i=new c(t/this.floorResolution,this.floorThickness,t/this.floorResolution);for(let r=0;r<this.floorResolution;r++)for(let h=0;h<this.floorResolution;h++)e.push(new j({position:c.add(n,new c(r*s,0,h*s)).add(c.scale(i,.5)),colour:o,scale:i}));return e}*createBalls(){const e=this.pegRadius*5,t=new c(this.ballRadius,this.ballRadius,this.ballRadius),n=new c(255,255,255);for(let s=0;s<this.maxBallCount;s++){const o=1*this.ballRadius*(Math.random()-.5),i=1*this.ballRadius*(Math.random()-.5);this.spheres.addObject(new j({position:c.add(this.start,new c(o,e,i)),scale:t,colour:n})),this.spheres.update(1),yield}}tick(e){this.initialised&&this.ballPhysicsShader.run(e)}async initialise(e){this.initialised||(this.spheres.initialise(this.scene,e),this.floor.initialise(this.scene,e),this.ballPhysicsShader=await F.create(e,this),this.initialised=!0)}}async function ae(){const l=document.getElementById("main"),e=new ce({ballCount:1e4,layers:8,pegRadius:3,floorResolution:256}),t=await D.create(l,{scene:e.scene,cameraOptions:{mouseSensitivity:.1,movementSpeed:.1}});await t.initialise(),await e.initialise(t.device),t.camera.position=new c(0,10,20),t.camera.fovDegrees=60,te();const n=new ee({wormholeThreshold:100}),s=e.createBalls();let o=s.next();const i=1;n.addCallback(r=>{!o.done&&r.frame%i===i-1&&(o=s.next()),t.camera.checkKeyboardInputs(r.deltaTime),e.tick(r.deltaTime),t.render()}),n.start(),l.addEventListener("click",()=>{l.requestPointerLock()})}ae().catch(l=>{const e=l instanceof Error?l.message:JSON.stringify(l),t=document.getElementById("message");t.classList.add("error"),t.textContent=e;const n=document.getElementById("chevron"),s=document.getElementById("content");n?.classList.add("collapsed"),s?.classList.add("collapsed"),console.error(e)});
